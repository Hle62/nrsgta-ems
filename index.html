// スプレッドシートのID
const SPREADSHEET_ID = '19hPtAuxc2COKwcdXr4FmZ7WCuvBcGl4zT7Oog-pMrCA'; 

// 各機能で使用するシート名
const EMPLOYEE_INFO_SHEET_NAME = '社員情報'; 
const ATTENDANCE_ARCHIVE_SHEET_NAME = '勤怠アーカイブ'; 

// DiscordウェブフックURLをあなたの環境に合わせて変更してください
const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1385565389299384492/t4M39HW5Ot4NXSyorrFZYOA7yNvG3pDfPv0Jt5sUS7bRJxa90ZTFMzxBj-MNKJdGoAmA'; // ★ここをあなたのDiscordウェブフックURLに書き換える★

/**
 * WebアプリからのPOSTリクエストを処理する主要関数
 * Webアプリからのリクエストに応じて、Discord通知またはスプレッドシート記録を行う
 */
function doPost(e) {
  const action = e.parameter.action; // 'notifyDiscord' または 'recordAttendance'

  if (action === 'notifyDiscord') {
    return handleDiscordNotification(e);
  } else if (action === 'recordAttendance') {
    return handleRecordAttendance(e);
  } else {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '不明なアクションです。' }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Discord通知のみを行う関数 (出勤/退勤ボタン押下時)
 */
function handleDiscordNotification(e) {
  const name = e.parameter.name;
  const type = e.parameter.type; // '出勤' or '退勤'
  const timestamp = new Date();

  if (!name || !type) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '名前または種別が指定されていません。' }))
                         .setMimeType(ContentService.MimeType.JSON);
  }

  try {
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
    // ↓↓ この行を以下のように修正してください ↓↓
    const discordMessage = `${name}-${type} (${Utilities.formatDate(timestamp, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss')})`;
    // ↑↑ 上記の1行が正しい形式です。他の記述がある場合は削除してください。 ↑↑
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
    sendDiscordNotification(discordMessage);

    return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'Discord通知が完了しました！' }))
                         .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('Discord通知エラー: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Discord通知中にエラーが発生しました: ' + error.message }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * スプレッドシートに勤務時間を記録する関数 (退勤ボタン押下時)
 */
function handleRecordAttendance(e) {
  const name = e.parameter.name;
  const startTime = e.parameter.startTime; // ISO形式文字列で渡される想定
  const endTime = e.parameter.endTime;     // ISO形式文字列で渡される想定
  const submissionTime = new Date(); // 勤怠提出時の日時

  if (!name || !startTime || !endTime) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '名前、業務開始時間、または業務終了時間が指定されていません。' }))
                         .setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(ATTENDANCE_ARCHIVE_SHEET_NAME);
    if (!sheet) {
      throw new Error(`シート名「${ATTENDANCE_ARCHIVE_SHEET_NAME}」が見つかりません。`);
    }

    const startJsDate = new Date(startTime);
    const endJsDate = new Date(endTime);
    
    // 勤務時間を計算 (ミリ秒)
    const durationMs = endJsDate.getTime() - startJsDate.getTime();
    // ミリ秒を HH時間MM分 形式に変換
    const hours = Math.floor(durationMs / (1000 * 60 * 60));
    const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
    const durationFormatted = `${hours}時間${minutes}分`;

    // スプレッドシートに追記
    // 列順: 勤怠提出時の日時 | 名前 | 業務開始時間 | 業務終了時間 | 勤務時間
    sheet.appendRow([
      Utilities.formatDate(submissionTime, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss'), // 勤怠提出時の日時
      name, // 名前
      Utilities.formatDate(startJsDate, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss'), // 業務開始時間
      Utilities.formatDate(endJsDate, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss'), // 業務終了時間
      durationFormatted // 勤務時間
    ]);

    return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: '勤務時間を記録しました！' }))
                         .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log('勤務時間記録エラー: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '勤務時間の記録中にエラーが発生しました: ' + error.message }))
                             .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * スプレッドシートから名前のリストを取得して返す関数
 * 「社員情報」タブのC列から名前を取得します。
 */
function doGet(e) {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(EMPLOYEE_INFO_SHEET_NAME);
    if (!sheet) {
      throw new Error(`シート名「${EMPLOYEE_INFO_SHEET_NAME}」が見つかりません。`);
    }

    const lastRow = sheet.getLastRow();
    let names = [];
    if (lastRow >= 2) { // 2行目以降にデータがある場合のみ処理
        // 変更点: getRangeの2番目の引数を列番号1 (A列) から 3 (C列) に変更
        const nameColumnData = sheet.getRange(2, 3, lastRow - 1, 1).getValues(); // 2行目から最終行までの3列目（C列）を取得
        const uniqueNames = new Set();
        nameColumnData.forEach(row => {
            const name = String(row[0]).trim();
            if (name !== '') {
                uniqueNames.add(name);
            }
        });
        names = Array.from(uniqueNames).sort();
    }

    return ContentService.createTextOutput(JSON.stringify({ status: 'success', names: names }))
                         .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log('名前リスト取得エラー: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '名前リスト取得エラー: ' + error.message }))
                             .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Discord Webhookにメッセージを送信する関数
 */
function sendDiscordNotification(message) {
  const payload = {
    content: message
  };
  const options = {
    'method' : 'post',
    'contentType': 'application/json',
    'payload' : JSON.stringify(payload),
    'muteHttpExceptions': true
  };

  try {
    const response = UrlFetchApp.fetch(DISCORD_WEBHOOK_URL, options);
    Logger.log('Discord Webhook Response: ' + response.getContentText());
  } catch (e) {
    Logger.log('Discord Webhook Error: ' + e.message);
  }
}
