// =========================================================================
// Google Apps Script (GAS) ã‚³ãƒ¼ãƒ‰ - å‹¤å‹™æ™‚é–“è¨ˆç®—çµæœã®ãƒ­ã‚°è¿½åŠ ç‰ˆ
// ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’GASã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„
// â˜…â˜…â˜… æ—¢å­˜ã®GASã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ã“ã®å†…å®¹ã§ä¸Šæ›¸ãã—ã¦ãã ã•ã„ â˜…â˜…â˜…
// =========================================================================

// â˜…â˜…â˜… ã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦ã€ä»¥ä¸‹ã®å¤‰æ•°ã‚’å¿…ãšç¢ºèªãƒ»å¤‰æ›´ã—ã¦ãã ã•ã„ â˜…â˜…â˜…

// 1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ID (ã”æä¾›ã„ãŸã ã„ãŸIDã§OKã§ã™)
const SPREADSHEET_ID = '19hPtAuxc2COKwcdXr4FmZ7WCuvBcGl4zT7Oog-pMrCA';

// 2. å„æ©Ÿèƒ½ã§ä½¿ç”¨ã™ã‚‹ã‚·ãƒ¼ãƒˆå
const EMPLOYEE_INFO_SHEET_NAME = 'ç¤¾å“¡æƒ…å ±'; // åå‰ãƒªã‚¹ãƒˆå–å¾—å…ƒï¼ˆCåˆ—ï¼‰
const ATTENDANCE_ARCHIVE_SHEET_NAME = 'å‹¤æ€ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'; // å‹¤æ€ è¨˜éŒ²ä¿å­˜å…ˆ

// 3. Discordã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯URL
const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1385565389299384492/t4M39HW5Ot4NXSyorrFZYOA7yNvG3pDfPv0Jt5sUS7bRJxa90ZTFMzxBj-MNKJdGoAmA'; 

// â˜…â˜…â˜… å¤‰æ›´ã¯ã“ã“ã¾ã§ã§ã™ â˜…â˜…â˜…


/**
 * Webã‚¢ãƒ—ãƒªã‹ã‚‰ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ä¸»è¦é–¢æ•°
 * ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® 'action' ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦å‡¦ç†ã‚’åˆ†å²ã—ã¾ã™ã€‚
 */
function doPost(e) {
  const action = e.parameter.action;
  Logger.log('--- doPost triggered. Action: ' + action + ' --- ' + new Date()); 

  if (action === 'notifyDiscord') {
    return handleDiscordNotification(e);
  } else if (action === 'recordAttendance') {
    return handleRecordAttendance(e);
  } else if (action === 'getNames') { // doGetä»¥å¤–ã§getNamesãŒå‘¼ã°ã‚Œã‚‹å¯èƒ½æ€§ã‚‚è€ƒæ…®ã—ã€doPostã«è¿½åŠ 
    return doGet(e); // doGetã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
  } else {
    Logger.log('Error: Unknown action received: ' + action);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'ä¸æ˜ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚' }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Webã‚¢ãƒ—ãƒªã‹ã‚‰ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆåå‰ãƒªã‚¹ãƒˆå–å¾—ï¼‰ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
 */
function doGet(e) {
  Logger.log('doGet triggered for name list.');
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(EMPLOYEE_INFO_SHEET_NAME);
    if (!sheet) {
      Logger.log(`Error: Sheet "${EMPLOYEE_INFO_SHEET_NAME}" not found for doGet.`);
      throw new Error(`ã‚·ãƒ¼ãƒˆåã€Œ${EMPLOYEE_INFO_SHEET_NAME}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    }
    const lastRow = sheet.getLastRow();
    let names = [];
    if (lastRow >= 2) {
        // Cåˆ— (3åˆ—ç›®) ã‹ã‚‰åå‰ã‚’å–å¾—ã€‚ã‚‚ã—Båˆ—ãªã‚‰2ã«ã—ã¦ãã ã•ã„ã€‚
        const nameColumnData = sheet.getRange(2, 3, lastRow - 1, 1).getValues(); 
        const uniqueNames = new Set();
        nameColumnData.forEach(row => {
            const name = String(row[0]).trim();
            if (name !== '') {
                uniqueNames.add(name);
            }
        });
        names = Array.from(uniqueNames).sort();
    }
    Logger.log('Name list fetched successfully. Count: ' + names.length);
    return ContentService.createTextOutput(JSON.stringify({ status: 'success', names: names }))
                         .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('Error in doGet (name list): ' + error.message + ' Stack: ' + error.stack);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'åå‰ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Discordé€šçŸ¥ã®ã¿ã‚’è¡Œã†é–¢æ•°
 */
function handleDiscordNotification(e) {
  const name = e.parameter.name;
  const type = e.parameter.type;
  const timestamp = new Date();
  Logger.log(`handleDiscordNotification triggered. Name: ${name}, Type: ${type}`);

  if (!name || !type) {
    Logger.log('Error: Missing parameters for Discord notification.');
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'åå‰ã¾ãŸã¯ç¨®åˆ¥ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚' }))
                         .setMimeType(ContentService.MimeType.JSON);
  }

  try {
    let discordMessage;
    // æ—¥æœ¬æ™‚é–“ã§ã®è¡¨ç¤ºã®ãŸã‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’ä½¿ç”¨
    const formattedTimestamp = Utilities.formatDate(timestamp, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');
    
    if (type === 'å‡ºå‹¤') {
        discordMessage = `ğŸ”” ${name}ã•ã‚“ãŒ**å‡ºå‹¤**ã—ã¾ã—ãŸï¼ (${formattedTimestamp})`;
    } else if (type === 'é€€å‹¤') {
        discordMessage = `ğŸšª ${name}ã•ã‚“ãŒ**é€€å‹¤**ã—ã¾ã—ãŸï¼ (${formattedTimestamp})`;
    } else if (type === 'å‹¤æ€ å–ã‚Šæ¶ˆã—') {
        discordMessage = `ğŸš« ${name}ã•ã‚“ã®**å‹¤æ€ è¨˜éŒ²ãŒå–ã‚Šæ¶ˆã—**ã•ã‚Œã¾ã—ãŸã€‚ (${formattedTimestamp})`;
    } else {
        discordMessage = `â„¹ï¸ ${name}ã•ã‚“ãŒä¸æ˜ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€Œ${type}ã€ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ (${formattedTimestamp})`;
    }
    
    sendDiscordNotification(discordMessage);
    Logger.log('Discord notification sent for: ' + discordMessage);
    return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'Discordé€šçŸ¥ãŒå®Œäº†ã—ã¾ã—ãŸï¼' }))
                         .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('Error in handleDiscordNotification: ' + error.message + ' Stack: ' + error.stack);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Discordé€šçŸ¥ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å‹¤å‹™æ™‚é–“ã‚’è¨˜éŒ²ã™ã‚‹é–¢æ•°
 * â˜…å‹¤å‹™æ™‚é–“è¨ˆç®—ã‚’æ™‚é–“å˜ä½ã®æ•°å€¤ã§è¡Œã†ã‚ˆã†ã«å¤‰æ›´â˜…
 */
function handleRecordAttendance(e) {
  Logger.log('--- handleRecordAttendance START (Ultra Detailed Log) ---');
  try {
    const name = e.parameter.name;
    const startTimeParam = e.parameter.startTime; // ISOæ–‡å­—åˆ—ã§æ¸¡ã•ã‚Œã‚‹
    const endTimeParam = e.parameter.endTime;     // ISOæ–‡å­—åˆ—ã§æ¸¡ã•ã‚Œã‚‹
    const submissionTime = new Date(); // GASãŒãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ãŸæ™‚åˆ»

    Logger.log(`[1] Params received: Name="${name}", Start="${startTimeParam}", End="${endTimeParam}"`);

    if (!name || !startTimeParam || !endTimeParam) {
      Logger.log('[2] Validation Error: Missing parameters.');
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'åå‰ã€æ¥­å‹™é–‹å§‹æ™‚é–“ã€ã¾ãŸã¯æ¥­å‹™çµ‚äº†æ™‚é–“ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚' }))
                           .setMimeType(ContentService.MimeType.JSON);
    }

    Logger.log('[3] Attempting to open spreadsheet with ID: ' + SPREADSHEET_ID);
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    if (!spreadsheet) {
      Logger.log('CRITICAL ERROR: Spreadsheet object is null. ID: ' + SPREADSHEET_ID);
      throw new Error(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã€Œ${SPREADSHEET_ID}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    }
    Logger.log('Spreadsheet successfully opened: ' + spreadsheet.getName());

    Logger.log('[4] Attempting to get sheet by name: ' + ATTENDANCE_ARCHIVE_SHEET_NAME);
    const sheet = spreadsheet.getSheetByName(ATTENDANCE_ARCHIVE_SHEET_NAME);
    if (!sheet) {
      Logger.log('CRITICAL ERROR: Sheet not found with name: ' + ATTENDANCE_ARCHIVE_SHEET_NAME + '. Please check sheet name and permissions.');
      throw new Error(`ã‚·ãƒ¼ãƒˆåã€Œ${ATTENDANCE_ARCHIVE_SHEET_NAME}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    }
    Logger.log('Sheet successfully obtained: ' + sheet.getName());

    Logger.log('[5] Parsing dates from strings...');
    const startJsDate = new Date(startTimeParam); 
    const endJsDate = new Date(endTimeParam);

    if (isNaN(startJsDate.getTime())) {
        Logger.log('CRITICAL ERROR: Invalid startJsDate. Original startTime string: "' + startTimeParam + '".');
        throw new Error('æ¥­å‹™é–‹å§‹æ™‚åˆ»ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™ã€‚');
    }
    if (isNaN(endJsDate.getTime())) {
        Logger.log('CRITICAL ERROR: Invalid endJsDate. Original endTime string: "' + endTimeParam + '".');
        throw new Error('æ¥­å‹™çµ‚äº†æ™‚åˆ»ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™ã€‚');
    }
    Logger.log(`[6] Parsed dates (ISO): Start=${startJsDate.toISOString()}, End=${endJsDate.toISOString()}`);
    
    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ã¦æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    const formattedStartTime = Utilities.formatDate(startJsDate, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');
    const formattedEndTime = Utilities.formatDate(endJsDate, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');
    const formattedSubmissionTime = Utilities.formatDate(submissionTime, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');

    // â˜…â˜…â˜… å‹¤å‹™æ™‚é–“ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´ â˜…â˜…â˜…
    const durationMs = endJsDate.getTime() - startJsDate.getTime();
    const durationHours = durationMs / (1000 * 60 * 60); // ãƒŸãƒªç§’ã‚’æ™‚é–“å˜ä½ã«å¤‰æ›
    const roundedDurationHours = Math.round(durationHours * 100) / 100; // å°æ•°ç‚¹ä»¥ä¸‹2æ¡ã«ä¸¸ã‚ã‚‹
    // â˜…â˜…â˜… å‹¤å‹™æ™‚é–“è¨ˆç®—çµæœã‚’ãƒ­ã‚°ã«å‡ºåŠ› â˜…â˜…â˜…
    Logger.log(`[6.5] Calculated duration (hours): ${roundedDurationHours}`);
    // â˜…â˜…â˜… ã“ã“ã¾ã§å¤‰æ›´ â˜…â˜…â˜…

    const rowData = [
      formattedSubmissionTime, // Aåˆ—: GASãŒãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ãŸæ™‚åˆ»
      name,                    // Båˆ—: ãƒ¦ãƒ¼ã‚¶ãƒ¼å
      formattedStartTime,      // Cåˆ—: å‡ºå‹¤æ™‚åˆ»
      formattedEndTime,        // Dåˆ—: é€€å‹¤æ™‚åˆ»
      roundedDurationHours     // Eåˆ—: å‹¤å‹™æ™‚é–“ (æ•°å€¤ã€ä¾‹: 8.5) â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ˜…
    ];
    
    Logger.log('[7] Attempting to append row with data: ' + JSON.stringify(rowData));
    sheet.appendRow(rowData); // ã“ã“ãŒæ›¸ãè¾¼ã¿ã®æ ¸å¿ƒ
    Logger.log('[8] appendRow call successful.');

    return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'å‹¤å‹™æ™‚é–“ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼' }))
                         .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log('CAUGHT FATAL ERROR in handleRecordAttendance: ' + error.message + ' --- Stack: ' + error.stack);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'å‹¤å‹™æ™‚é–“ã®è¨˜éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message }))
                         .setMimeType(ContentService.MimeType.JSON);
  } finally {
    Logger.log('--- handleRecordAttendance END (Ultra Detailed Log) ---');
  }
}

/**
 * Discord Webhookã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹å†…éƒ¨é–¢æ•°
 */
function sendDiscordNotification(message) {
  const payload = {
    content: message
  };
  const options = {
    'method' : 'post',
    'contentType': 'application/json',
    'payload' : JSON.stringify(payload),
    'muteHttpExceptions': true
  };

  try {
    const response = UrlFetchApp.fetch(DISCORD_WEBHOOK_URL, options);
    Logger.log('Discord Webhook Response: ' + response.getContentText());
  } catch (e) {
    Logger.log('Discord Webhook Error: ' + e.message);
  }
}

// =========================================================================
// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
// =========================================================================

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
 * ã€Œç¤¾å“¡æƒ…å ±ã€ã‚¿ãƒ–ã®Aåˆ—ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«å‹•ä½œã—ã¾ã™ã€‚
 * @param {GoogleAppsScript.Events.Sheets.SheetChangeEvent} e ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function onEdit(e) {
  Logger.log('onEdit triggered.');
  const range = e.range;
  const sheet = range.getSheet();

  // Aåˆ—ã¯åˆ—ç•ªå·1ã€Båˆ—ã¯2ã€Cåˆ—ã¯3...
  if (sheet.getName() === EMPLOYEE_INFO_SHEET_NAME && range.getColumn() === 1) { 
    Logger.log('onEdit: Employee info sheet and A column edited. Row: ' + range.getRow() + ', Value: ' + range.getValue());
    const row = range.getRow();
    const value = range.getValue();

    if (row === 1) return; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ç·¨é›†ã¯ç„¡è¦–

    // æ—¢å­˜ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å‰Šé™¤ã—ã€æ–°ã—ã„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
    const filterRange = sheet.getRange(1, 1, sheet.getLastRow(), sheet.getLastColumn());
    let filter = sheet.getFilter();
    if (filter) {
      filter.remove();
      Logger.log('Existing filter removed.');
    }
    filter = filterRange.createFilter();
    Logger.log('New filter created.');

    applyConditionalFormatting(sheet);
    Logger.log('Conditional formatting applied.');

    // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„è¡Œï¼ˆFALSEï¼‰ã‚’éè¡¨ç¤ºã«ã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®š
    const filterCriteria = SpreadsheetApp.newFilterCriteria()
      .setHiddenValues([true]) // TRUEã®å€¤ã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒTRUEã®è¡Œã‚’éè¡¨ç¤ºï¼‰
      .build();

    filter.setColumnFilterCriteria(1, filterCriteria); // Aåˆ—ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
    Logger.log('Filter criteria set for column A.');
  }
}

/**
 * ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸè¡Œã«æ¡ä»¶ä»˜ãæ›¸å¼ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
 * æ›¸å¼è¨­å®šãƒ«ãƒ¼ãƒ«ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰å†é©ç”¨ã—ã¾ã™ã€‚
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆ
 */
function applyConditionalFormatting(sheet) {
  Logger.log('Applying conditional formatting.');
  // æ—¢å­˜ã®æ¡ä»¶ä»˜ãæ›¸å¼ãƒ«ãƒ¼ãƒ«ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
  let rules = sheet.getConditionalFormatRules();
  while (rules.length > 0) {
    sheet.removeConditionalFormatRule(0); 
    rules = sheet.getConditionalFormatRules(); 
  }
  Logger.log('Existing conditional formatting rules cleared.');

  const range = sheet.getDataRange(); // ã‚·ãƒ¼ãƒˆå…¨ä½“ã«é©ç”¨ï¼ˆãƒ‡ãƒ¼ã‚¿ã®ã‚ã‚‹ç¯„å›²ï¼‰
  const rule = SpreadsheetApp.newConditionalFormatRule()
      .whenFormulaSatisfied("=$A1=TRUE") // Aåˆ—ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒTRUEã®å ´åˆã€ãã®è¡Œã«é©ç”¨
      .setBackground("#cccccc") // èƒŒæ™¯è‰²ã‚’ã‚°ãƒ¬ãƒ¼ã«è¨­å®š
      .setFontColor("#808080") // æ–‡å­—è‰²ã‚‚å°‘ã—è–„ã„ã‚°ãƒ¬ãƒ¼ã«
      .setRanges([range]) // ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã™ã‚‹ç¯„å›²
      .build();
  
  sheet.setConditionalFormatRules([rule]); // æ–°ã—ã„ãƒ«ãƒ¼ãƒ«ã‚’ã‚·ãƒ¼ãƒˆã«è¨­å®š
  Logger.log('New conditional formatting rule set.');
}
