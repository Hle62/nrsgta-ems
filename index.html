// =========================================================================
// Google Apps Script (GAS) コード - 勤務時間計算結果のログ追加版
// このコードをGASエディタにコピー＆ペーストしてください
// ★★★ 既存のGASコード全体をこの内容で上書きしてください ★★★
// =========================================================================

// ★★★ あなたの環境に合わせて、以下の変数を必ず確認・変更してください ★★★

// 1. スプレッドシートのID (ご提供いただいたIDでOKです)
const SPREADSHEET_ID = '19hPtAuxc2COKwcdXr4FmZ7WCuvBcGl4zT7Oog-pMrCA';

// 2. 各機能で使用するシート名
const EMPLOYEE_INFO_SHEET_NAME = '社員情報'; // 名前リスト取得元（C列）
const ATTENDANCE_ARCHIVE_SHEET_NAME = '勤怠アーカイブ'; // 勤怠記録保存先

// 3. DiscordウェブフックURL
const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1385565389299384492/t4M39HW5Ot4NXSyorrFZYOA7yNvG3pDfPv0Jt5sUS7bRJxa90ZTFMzxBj-MNKJdGoAmA'; 

// ★★★ 変更はここまでです ★★★


/**
 * WebアプリからのPOSTリクエストを処理する主要関数
 * リクエストの 'action' パラメータに基づいて処理を分岐します。
 */
function doPost(e) {
  const action = e.parameter.action;
  Logger.log('--- doPost triggered. Action: ' + action + ' --- ' + new Date()); 

  if (action === 'notifyDiscord') {
    return handleDiscordNotification(e);
  } else if (action === 'recordAttendance') {
    return handleRecordAttendance(e);
  } else if (action === 'getNames') { // doGet以外でgetNamesが呼ばれる可能性も考慮し、doPostに追加
    return doGet(e); // doGetと同じロジックを呼び出す
  } else {
    Logger.log('Error: Unknown action received: ' + action);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '不明なアクションです。' }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * WebアプリからのGETリクエスト（名前リスト取得）を処理する関数
 */
function doGet(e) {
  Logger.log('doGet triggered for name list.');
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(EMPLOYEE_INFO_SHEET_NAME);
    if (!sheet) {
      Logger.log(`Error: Sheet "${EMPLOYEE_INFO_SHEET_NAME}" not found for doGet.`);
      throw new Error(`シート名「${EMPLOYEE_INFO_SHEET_NAME}」が見つかりません。`);
    }
    const lastRow = sheet.getLastRow();
    let names = [];
    if (lastRow >= 2) {
        // C列 (3列目) から名前を取得。もしB列なら2にしてください。
        const nameColumnData = sheet.getRange(2, 3, lastRow - 1, 1).getValues(); 
        const uniqueNames = new Set();
        nameColumnData.forEach(row => {
            const name = String(row[0]).trim();
            if (name !== '') {
                uniqueNames.add(name);
            }
        });
        names = Array.from(uniqueNames).sort();
    }
    Logger.log('Name list fetched successfully. Count: ' + names.length);
    return ContentService.createTextOutput(JSON.stringify({ status: 'success', names: names }))
                         .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('Error in doGet (name list): ' + error.message + ' Stack: ' + error.stack);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '名前リスト取得エラー: ' + error.message }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Discord通知のみを行う関数
 */
function handleDiscordNotification(e) {
  const name = e.parameter.name;
  const type = e.parameter.type;
  const timestamp = new Date();
  Logger.log(`handleDiscordNotification triggered. Name: ${name}, Type: ${type}`);

  if (!name || !type) {
    Logger.log('Error: Missing parameters for Discord notification.');
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '名前または種別が指定されていません。' }))
                         .setMimeType(ContentService.MimeType.JSON);
  }

  try {
    let discordMessage;
    // 日本時間での表示のためにスクリプトのタイムゾーンを使用
    const formattedTimestamp = Utilities.formatDate(timestamp, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');
    
    if (type === '出勤') {
        discordMessage = `🔔 ${name}さんが**出勤**しました！ (${formattedTimestamp})`;
    } else if (type === '退勤') {
        discordMessage = `🚪 ${name}さんが**退勤**しました！ (${formattedTimestamp})`;
    } else if (type === '勤怠取り消し') {
        discordMessage = `🚫 ${name}さんの**勤怠記録が取り消し**されました。 (${formattedTimestamp})`;
    } else {
        discordMessage = `ℹ️ ${name}さんが不明なアクション「${type}」を実行しました。 (${formattedTimestamp})`;
    }
    
    sendDiscordNotification(discordMessage);
    Logger.log('Discord notification sent for: ' + discordMessage);
    return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'Discord通知が完了しました！' }))
                         .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('Error in handleDiscordNotification: ' + error.message + ' Stack: ' + error.stack);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Discord通知中にエラーが発生しました: ' + error.message }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * スプレッドシートに勤務時間を記録する関数
 * ★勤務時間計算を時間単位の数値で行うように変更★
 */
function handleRecordAttendance(e) {
  Logger.log('--- handleRecordAttendance START (Ultra Detailed Log) ---');
  try {
    const name = e.parameter.name;
    const startTimeParam = e.parameter.startTime; // ISO文字列で渡される
    const endTimeParam = e.parameter.endTime;     // ISO文字列で渡される
    const submissionTime = new Date(); // GASがデータを受け取った時刻

    Logger.log(`[1] Params received: Name="${name}", Start="${startTimeParam}", End="${endTimeParam}"`);

    if (!name || !startTimeParam || !endTimeParam) {
      Logger.log('[2] Validation Error: Missing parameters.');
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '名前、業務開始時間、または業務終了時間が指定されていません。' }))
                           .setMimeType(ContentService.MimeType.JSON);
    }

    Logger.log('[3] Attempting to open spreadsheet with ID: ' + SPREADSHEET_ID);
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    if (!spreadsheet) {
      Logger.log('CRITICAL ERROR: Spreadsheet object is null. ID: ' + SPREADSHEET_ID);
      throw new Error(`スプレッドシートID「${SPREADSHEET_ID}」が見つかりません。`);
    }
    Logger.log('Spreadsheet successfully opened: ' + spreadsheet.getName());

    Logger.log('[4] Attempting to get sheet by name: ' + ATTENDANCE_ARCHIVE_SHEET_NAME);
    const sheet = spreadsheet.getSheetByName(ATTENDANCE_ARCHIVE_SHEET_NAME);
    if (!sheet) {
      Logger.log('CRITICAL ERROR: Sheet not found with name: ' + ATTENDANCE_ARCHIVE_SHEET_NAME + '. Please check sheet name and permissions.');
      throw new Error(`シート名「${ATTENDANCE_ARCHIVE_SHEET_NAME}」が見つかりません。`);
    }
    Logger.log('Sheet successfully obtained: ' + sheet.getName());

    Logger.log('[5] Parsing dates from strings...');
    const startJsDate = new Date(startTimeParam); 
    const endJsDate = new Date(endTimeParam);

    if (isNaN(startJsDate.getTime())) {
        Logger.log('CRITICAL ERROR: Invalid startJsDate. Original startTime string: "' + startTimeParam + '".');
        throw new Error('業務開始時刻のデータが不正です。');
    }
    if (isNaN(endJsDate.getTime())) {
        Logger.log('CRITICAL ERROR: Invalid endJsDate. Original endTime string: "' + endTimeParam + '".');
        throw new Error('業務終了時刻のデータが不正です。');
    }
    Logger.log(`[6] Parsed dates (ISO): Start=${startJsDate.toISOString()}, End=${endJsDate.toISOString()}`);
    
    // スクリプトのタイムゾーンを考慮して日付をフォーマット
    const formattedStartTime = Utilities.formatDate(startJsDate, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');
    const formattedEndTime = Utilities.formatDate(endJsDate, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');
    const formattedSubmissionTime = Utilities.formatDate(submissionTime, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm:ss');

    // ★★★ 勤務時間の計算ロジックを変更 ★★★
    const durationMs = endJsDate.getTime() - startJsDate.getTime();
    const durationHours = durationMs / (1000 * 60 * 60); // ミリ秒を時間単位に変換
    const roundedDurationHours = Math.round(durationHours * 100) / 100; // 小数点以下2桁に丸める
    // ★★★ 勤務時間計算結果をログに出力 ★★★
    Logger.log(`[6.5] Calculated duration (hours): ${roundedDurationHours}`);
    // ★★★ ここまで変更 ★★★

    const rowData = [
      formattedSubmissionTime, // A列: GASがデータを受け取った時刻
      name,                    // B列: ユーザー名
      formattedStartTime,      // C列: 出勤時刻
      formattedEndTime,        // D列: 退勤時刻
      roundedDurationHours     // E列: 勤務時間 (数値、例: 8.5) ★修正ポイント★
    ];
    
    Logger.log('[7] Attempting to append row with data: ' + JSON.stringify(rowData));
    sheet.appendRow(rowData); // ここが書き込みの核心
    Logger.log('[8] appendRow call successful.');

    return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: '勤務時間を記録しました！' }))
                         .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log('CAUGHT FATAL ERROR in handleRecordAttendance: ' + error.message + ' --- Stack: ' + error.stack);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '勤務時間の記録中にエラーが発生しました: ' + error.message }))
                         .setMimeType(ContentService.MimeType.JSON);
  } finally {
    Logger.log('--- handleRecordAttendance END (Ultra Detailed Log) ---');
  }
}

/**
 * Discord Webhookにメッセージを送信する内部関数
 */
function sendDiscordNotification(message) {
  const payload = {
    content: message
  };
  const options = {
    'method' : 'post',
    'contentType': 'application/json',
    'payload' : JSON.stringify(payload),
    'muteHttpExceptions': true
  };

  try {
    const response = UrlFetchApp.fetch(DISCORD_WEBHOOK_URL, options);
    Logger.log('Discord Webhook Response: ' + response.getContentText());
  } catch (e) {
    Logger.log('Discord Webhook Error: ' + e.message);
  }
}

// =========================================================================
// チェックボックスの変更を検知する関数 (変更なし)
// =========================================================================

/**
 * スプレッドシートの編集イベント時に自動実行される関数
 * 「社員情報」タブのA列のチェックボックスが変更された際に動作します。
 * @param {GoogleAppsScript.Events.Sheets.SheetChangeEvent} e イベントオブジェクト
 */
function onEdit(e) {
  Logger.log('onEdit triggered.');
  const range = e.range;
  const sheet = range.getSheet();

  // A列は列番号1、B列は2、C列は3...
  if (sheet.getName() === EMPLOYEE_INFO_SHEET_NAME && range.getColumn() === 1) { 
    Logger.log('onEdit: Employee info sheet and A column edited. Row: ' + range.getRow() + ', Value: ' + range.getValue());
    const row = range.getRow();
    const value = range.getValue();

    if (row === 1) return; // ヘッダー行の編集は無視

    // 既存のフィルターを削除し、新しいフィルターを適用
    const filterRange = sheet.getRange(1, 1, sheet.getLastRow(), sheet.getLastColumn());
    let filter = sheet.getFilter();
    if (filter) {
      filter.remove();
      Logger.log('Existing filter removed.');
    }
    filter = filterRange.createFilter();
    Logger.log('New filter created.');

    applyConditionalFormatting(sheet);
    Logger.log('Conditional formatting applied.');

    // チェックされていない行（FALSE）を非表示にするフィルターを設定
    const filterCriteria = SpreadsheetApp.newFilterCriteria()
      .setHiddenValues([true]) // TRUEの値を非表示にする（チェックボックスがTRUEの行を非表示）
      .build();

    filter.setColumnFilterCriteria(1, filterCriteria); // A列にフィルターを適用
    Logger.log('Filter criteria set for column A.');
  }
}

/**
 * チェックされた行に条件付き書式を適用する関数
 * 書式設定ルールを全てクリアしてから再適用します。
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet 対象のシート
 */
function applyConditionalFormatting(sheet) {
  Logger.log('Applying conditional formatting.');
  // 既存の条件付き書式ルールを全てクリア
  let rules = sheet.getConditionalFormatRules();
  while (rules.length > 0) {
    sheet.removeConditionalFormatRule(0); 
    rules = sheet.getConditionalFormatRules(); 
  }
  Logger.log('Existing conditional formatting rules cleared.');

  const range = sheet.getDataRange(); // シート全体に適用（データのある範囲）
  const rule = SpreadsheetApp.newConditionalFormatRule()
      .whenFormulaSatisfied("=$A1=TRUE") // A列のチェックボックスがTRUEの場合、その行に適用
      .setBackground("#cccccc") // 背景色をグレーに設定
      .setFontColor("#808080") // 文字色も少し薄いグレーに
      .setRanges([range]) // ルールを適用する範囲
      .build();
  
  sheet.setConditionalFormatRules([rule]); // 新しいルールをシートに設定
  Logger.log('New conditional formatting rule set.');
}
